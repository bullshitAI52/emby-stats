# Emby Stats 时区修复版使用说明

## 快速开始

这个版本修复了时区显示问题,所有时间都能正确显示为本地时间(如上海时间 UTC+8)。

## 方式一: 使用 Docker Compose (推荐)

### 1. 下载配置文件

创建一个新文件夹,下载 `docker-compose.yml`:

```bash
mkdir emby-stats
cd emby-stats
curl -O https://raw.githubusercontent.com/bullshitAI52/emby-stats/main/docker-compose.yml
```

或者手动创建 `docker-compose.yml` 文件,内容如下:

```yaml
services:
  emby-stats:
    image: qc0624/emby-stats:latest
    container_name: emby-stats
    restart: unless-stopped
    ports:
      - "8899:8000"
    volumes:
      # 修改为你的 Emby 数据目录
      - /path/to/emby/data:/data
      - emby-stats-config:/config
    environment:
      # 时区设置
      - TZ=Asia/Shanghai
      # 数据库路径(容器内路径)
      - PLAYBACK_DB=/data/playback_reporting.db
      - USERS_DB=/data/users.db
      - AUTH_DB=/data/authentication.db
      # Emby 服务器地址
      - EMBY_URL=http://your-emby-server:8096
      # 时区偏移(小时),上海为 +8
      - TZ_OFFSET=8

volumes:
  emby-stats-config:
```

### 2. 修改配置

编辑 `docker-compose.yml`,修改以下内容:

```yaml
volumes:
  # 改成你实际的 Emby 数据目录
  - /path/to/emby/data:/data
  
environment:
  # 改成你的 Emby 服务器地址
  - EMBY_URL=http://your-emby-server:8096
  
  # 如果不是上海时区,修改这两项
  - TZ=Asia/Shanghai      # 你的时区
  - TZ_OFFSET=8           # 时区偏移(小时)
```

### 3. 启动服务

```bash
docker-compose up -d
```

### 4. 访问界面

打开浏览器访问: http://localhost:8899

## 方式二: 直接使用 Docker 命令

```bash
docker run -d \
  --name emby-stats \
  --restart unless-stopped \
  -p 8899:8000 \
  -v /path/to/emby/data:/data \
  -v emby-stats-config:/config \
  -e TZ=Asia/Shanghai \
  -e PLAYBACK_DB=/data/playback_reporting.db \
  -e USERS_DB=/data/users.db \
  -e AUTH_DB=/data/authentication.db \
  -e EMBY_URL=http://your-emby-server:8096 \
  -e TZ_OFFSET=8 \
  qc0624/emby-stats:latest
```

记得修改:
- `/path/to/emby/data` → 你的 Emby 数据目录
- `http://your-emby-server:8096` → 你的 Emby 服务器地址

## 方式三: 从源码构建(包含时区修复)

如果你想使用包含时区修复的最新代码:

### 1. 克隆修复后的仓库

```bash
git clone https://github.com/bullshitAI52/emby-stats.git
cd emby-stats
```

### 2. 修改配置

编辑 `docker-compose.yml`,修改 Emby 数据目录和服务器地址

### 3. 构建并启动

```bash
docker-compose up -d --build
```

## 时区配置说明

### 常见时区设置

| 时区 | TZ 值 | TZ_OFFSET |
|------|-------|-----------|
| 上海/北京 | Asia/Shanghai | 8 |
| 东京 | Asia/Tokyo | 9 |
| 纽约 | America/New_York | -5 (夏令时 -4) |
| 伦敦 | Europe/London | 0 (夏令时 +1) |
| 洛杉矶 | America/Los_Angeles | -8 (夏令时 -7) |

### 重要提示

⚠️ **`TZ` 和 `TZ_OFFSET` 必须匹配!**

- `TZ`: 系统时区,影响日志和系统操作
- `TZ_OFFSET`: SQLite 查询时的时区偏移,影响数据库时间转换

两者必须对应同一个时区,否则时间显示仍会不正确。

## 验证修复是否生效

启动后,检查以下内容:

### 1. 播放历史时间

- 打开 "最近播放" 页面
- 检查显示的时间是否与实际播放时间一致
- 应该显示为你的本地时间(如上海时间)

### 2. 活跃时段热力图

- 打开 "概览" 页面
- 查看 "活跃时段分布" 热力图
- 高峰时段应该与你的实际观看习惯一致

### 3. 对比 Emby 服务器

- 在 Emby 服务器中查看相同的播放记录
- 两边显示的时间应该一致

## 更新到修复版本

如果你已经在使用旧版本:

```bash
# 停止并删除旧容器
docker-compose down

# 拉取最新镜像
docker-compose pull

# 重新启动
docker-compose up -d
```

## 故障排除

### 时间仍然显示不正确

1. **检查配置:**
   ```bash
   docker exec emby-stats env | grep TZ
   ```
   确认 `TZ` 和 `TZ_OFFSET` 设置正确

2. **清除浏览器缓存:**
   - 硬刷新: `Cmd+Shift+R` (Mac) 或 `Ctrl+Shift+R` (Windows)
   - 或完全清除浏览器缓存

3. **重启容器:**
   ```bash
   docker-compose restart
   ```

### 无法访问界面

1. **检查容器状态:**
   ```bash
   docker-compose ps
   docker-compose logs emby-stats
   ```

2. **检查端口占用:**
   ```bash
   lsof -i :8899
   ```

3. **更改端口:**
   修改 `docker-compose.yml` 中的端口映射:
   ```yaml
   ports:
     - "8899:8000"  # 改成其他端口,如 "9000:8000"
   ```

## 技术支持

- **修复说明:** https://github.com/bullshitAI52/emby-stats/blob/main/TIMEZONE_FIX.md
- **原项目:** https://github.com/qingcheng00624/emby-stats
- **问题反馈:** https://github.com/bullshitAI52/emby-stats/issues

## 修复内容

本版本修复了以下问题:

✅ 活跃时段分布时间显示不正确  
✅ 播放历史时间显示不正确  
✅ 所有时间显示都偏移 8 小时  

详细修复说明请查看: [TIMEZONE_FIX.md](https://github.com/bullshitAI52/emby-stats/blob/main/TIMEZONE_FIX.md)

---

**更新日期:** 2026-01-15  
**版本:** 时区修复版
